## Dashboard UI インストール
#
- name: Download Dashboard Manifest
  get_url:
    url: "https://raw.githubusercontent.com/kubernetes/dashboard/{{ kubernetes_dashborad_ver }}/aio/deploy/recommended.yaml"
    dest: /home/vagrant/
    mode: '0644'
    owner: vagrant
    group: vagrant

- name: Change Dashboard RBAC
  replace:
    path: /home/vagrant/recommended.yaml
    after: '  kind: ClusterRole'
    regexp: '^  name: kubernetes-dashboard'
    replace: '  name: cluster-admin'

- name: Insert nodePort
  blockinfile:
    path: /home/vagrant/recommended.yaml
    insertafter: "      targetPort: 8443"
    block: |2
            nodePort: 30445
        type: NodePort

      
- name: Deploy Dashboard UI
  become_user: vagrant
  command: kubectl apply -f /home/vagrant/recommended.yaml

- name: setup kubeconfig
  become_user: vagrant    
  shell: |
        ##KUBECONFIG=/srv/k8s/kubeconfig/admin.kubeconfig
        TOKEN=$(kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret |grep kubernetes-dashboard-token-* | awk '{print $1}') |awk '$1=="token:"{print $2}')
        kubectl config set-credentials kubernetes-admin --token="${TOKEN}"
        
