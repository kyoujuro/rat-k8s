### THIS FILE IS GENERATED BY setup.rb ###
### Template file is templates/playbook/etcd.yaml.template
#
# ETCD認証局
#

- name: Create ETCD CA working directory
  file:
    path: /srv/k8s/ca-etcd
    state: directory
    owner: vagrant
    group: vagrant

#
# ETCD CAの作成
#
- name: Create Etcd CA
  template:  
    src: etcd-ca-config.json
    dest: /srv/k8s/ca-etcd
    owner: vagrant
    group: vagrant
    mode: '0644'
- template:
    src: etcd-ca-csr.json
    dest: /srv/k8s/ca-etcd
    owner: vagrant
    group: vagrant
    mode: '0644'
- shell: |
    cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare etcd-ca
  args:
    chdir: /srv/k8s/ca-etcd


#
# ETCD サーバー証明書
#
- name: ETCD Server Certificate
  template:
    src: etcd-csr.json
    dest: /srv/k8s/ca-etcd
    owner: vagrant
    group: vagrant
    mode: '0644'
- shell: |
    cfssl gencert \
      -ca=etcd-ca.pem \
      -ca-key=etcd-ca-key.pem \
      -config=etcd-ca-config.json \
      -hostname=10.32.0.1,master1,172.16.19.11,,,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.svc.cluster.local \
      -profile=kubernetes \      
    etcd-csr.json | cfssljson -bare etcd-server
  args:
    chdir: /srv/k8s/ca-etcd

#
# ETCD ピア証明書
#
- name: ETCD Peer Certificate
  template:
    src: etcd-peer-csr.json
    dest: /srv/k8s/ca-etcd
    owner: vagrant
    group: vagrant
    mode: '0644'
- shell: |
    cfssl gencert \
      -ca=etcd-ca.pem \
      -ca-key=etcd-ca-key.pem \
      -config=etcd-ca-config.json \
      -hostname=10.32.0.1,master1,172.16.19.11,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.svc.cluster.local \      
      -profile=kubernetes \
    etcd-peer-csr.json | cfssljson -bare etcd-peer
  args:
    chdir: /srv/k8s/ca-etcd









